{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": {
    "text": { "signal": "'Age × Year Heatmap — ' + stateSel" },
    "subtitle": "Temporal shift in the age profile across 2014–2023 · Color intensity shows deaths",
    "anchor": "start",
    "fontSize": 16,
    "fontWeight": "bold",
    "offset": 8
  },
  "width": 800,
  "height": 520,
  
  "params": [
    {
      "name": "stateSel",
      "value": "New South Wales",
      "bind": {
        "input": "select",
        "name": "State: ",
        "options": [
          "New South Wales",
          "Victoria",
          "Queensland",
          "South Australia",
          "Western Australia",
          "Tasmania",
          "Northern Territory",
          "Australian Capital Territory"
        ]
      }
    },
    {
      "name": "metricSel",
      "value": "Deaths",
      "bind": {
        "input": "radio",
        "options": ["Deaths", "Share"],
        "name": "Metric: "
      }
    }
  ],
  
  "data": {
    "url": "data/AUS_Deaths_ByState_Age_2014_2023.csv",
    "format": { "type": "csv", "parse": { "Year": "number", "Deaths": "number" } }
  },
  
  "transform": [
    { "calculate": "trim(datum.Age_group)", "as": "Age_group" },
    { "filter": "datum.Region == stateSel" },
    { "filter": "datum.Age_group != 'All persons'" },
    { "aggregate": [{ "op": "sum", "field": "Deaths", "as": "Deaths" }], "groupby": ["Year", "Age_group"] },
    { "joinaggregate": [{ "op": "sum", "field": "Deaths", "as": "YearTotal" }], "groupby": ["Year"] },
    { "calculate": "datum.Deaths / datum.YearTotal", "as": "Share" },
    { "calculate": "metricSel == 'Deaths' ? datum.Deaths : datum.Share", "as": "Value" }
  ],
  
  "mark": { "type": "rect", "stroke": "white", "strokeWidth": 1 },
  
  "encoding": {
    "x": {
      "field": "Year",
      "type": "ordinal",
      "axis": {
        "title": null,
        "labelAngle": 0,
        "labelFontSize": 11
      }
    },
    "y": {
      "field": "Age_group",
      "type": "nominal",
      "sort": [
        "Under 1 year",
        "1-14 years",
        "15-24 years",
        "25-34 years",
        "35-44 years",
        "45-54 years",
        "55-64 years",
        "65-74 years",
        "75-84 years",
        "85 years and over"
      ],
      "axis": {
        "title": null,
        "labelFontSize": 11
      }
    },
    "color": {
      "field": "Value",
      "type": "quantitative",
      "scale": {
        "scheme": "blues",
        "type": "linear"
      },
      "legend": {
        "title": { "signal": "metricSel == 'Deaths' ? 'Deaths' : 'Share'" },
        "format": { "signal": "metricSel == 'Deaths' ? '~s' : '.1%'" },
        "orient": "right",
        "gradientLength": 300,
        "titleFontSize": 12,
        "labelFontSize": 11
      }
    },
    "tooltip": [
      { "field": "Age_group", "title": "Age group" },
      { "field": "Year", "type": "quantitative", "format": "d", "title": "Year" },
      { "field": "Deaths", "type": "quantitative", "format": ",", "title": "Deaths" },
      { "field": "Share", "type": "quantitative", "format": ".1%", "title": "Share of year" },
      { "expr": "stateSel", "title": "State" }
    ]
  },
  
  "config": {
    "view": { "stroke": null },
    "axis": { "domain": false, "ticks": false },
    "title": {
      "anchor": "start",
      "offset": 5,
      "subtitleColor": "#666",
      "subtitleFontSize": 12,
      "subtitlePadding": 3
    }
  }
}
